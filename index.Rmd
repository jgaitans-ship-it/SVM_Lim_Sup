---
title: "SVM"
output: html_document
date: "2026-01-06"
---
# ============================================================
# 1. Cargar librerías
# ============================================================

```{r}
library(terra)
library(raster)       # Para trabajar con datos raster
library(sf)           # Para manipulación de datos espaciales
library(openxlsx)     # Para manejar archivos Excel
library(tidyverse)    # Conjunto de paquetes para manipulación de datos\library(DataExplorer) # Exploración de datos
library(tmap)        # Visualización de mapas\library(ithir)       # Modelado de suelos
library(aqp)         # Análisis de perfiles de suelo
library(readxl)
```

# ============================================================
# 1. Carpeta donde están TODOS los rásters ya procesados
# ============================================================

# ============================================================
# 2. Lista de rásters que SÍ quieres usar
#    (nombres exactos de los archivos)
# ============================================================

```{r}
ruta <- "D:/Meta_vichada/aligned/"

rasters_sel <- c(
  #"Aspect.tif",
  "C.O.tif",
  "CI.tif",
  #"Convergence_Index.tif",
  #"Hillshade.tif",
  #"HH.tif",
  "HV.tif",
  "LS_Factor.tif",
  "MCARI.tif",
  "NDTI.tif",
  #"Plan_Curvature.tif",
  #"Precipitación.tif",
  #"Profile_Curvature.tif",
  "Relative_Slope_Position.tif",
  "Suelos_.tif",
  #"Temperatura_Media_.tif",
  "Topographic_Wetness_Index.tif",
  #"Total_Catchment_Area.tif",
  "Valley_Depth.tif"
  #"GNDVI.tif",
  #"BSI.tif",
  #"Channel_Network_Base_Level.tif",
  #"Channel_Network_Distance.tif",
  #"DEM.tif",
  #"EVI.tif",
  #"NBR.tif",
  #"NDVI.tif",
  #"NDWI.tif",
  #"SAVI.tif",
  #"Slope.tif"
  #"Temperatura_Maxima_.tif",
  #"Temperatura_Minima_.tif",
)
```


# ============================================================
# 3. Construir rutas completas SOLO de los seleccionados
# ============================================================

```{r}
files_sel <- file.path(ruta, rasters_sel)
```

# ============================================================
# 4. Verificar cuáles existen (control de errores)
# ============================================================
```{r}
files_sel <- files_sel[file.exists(files_sel)]

# Si alguno falta, aquí lo ves
print(basename(files_sel))

```
# ============================================================
# 5. Cargar como SpatRaster
# ============================================================

```{r}
raster <- rast(files_sel)

```

# ============================================================
# 6. Verificación rápida
# ============================================================

```{r}
compareGeom(raster, raster[[1]], stopOnError = TRUE)
```

# ============================================================
# 7. Visualización
# ============================================================

```{r}
plot(raster)
```
# ============================================================
# 8. Obtener coordenadas únicas
# ============================================================

```{r}
SCHS <- read_excel("D:/MAESTRIA/Trabajo_final/SCHS.xlsx")

Coor <- data.frame(Perfil_COD1=SCHS$Perfil_COD1,
                 Latitud = SCHS$Latitud,
                 Longitud = SCHS$Longitud,
                 Lim_sup = SCHS$lim_sup)
#Lim_inf = SCHS$lim_inf )

View(Coor)
str(Coor)


```

# ============================================================
# . Convertir a formato espacial (sf)
# ============================================================

```{r}
data_final_sf <- st_as_sf(x = Coor,
                          coords = c("Longitud", "Latitud"),
                          crs = st_crs(4326))
view(data_final_sf)
```


# ============================================================
# . Visualizar los puntos sobre el modelo de elevación (DEM)
# ============================================================

```{r}
plot(raster$Topographic_Wetness_Index)
plot(st_geometry(data_final_sf), add = TRUE, col= "red", pch = 16, lwd = 2)
```

# ============================================================
# .  Visualización con tmap
# ============================================================

```{r}
tm_shape(raster$Topographic_Wetness_Index) +
  tm_raster(palette = c("#CCCCCC", "#999999", "#666666", "#333333", "#000000")) +
  tm_shape(data_final_sf) +
  tm_dots("Lim_sup", palette = "-RdYlBu", size = 0.25) +
  tm_layout("Mapa Lim_Sup cm") +
  tm_compass() +
  tm_scale_bar()
```



# ============================================================
# . Extraer valores raster en los puntos espaciales
# ============================================================

```{r}
extraccion <- terra::extract(raster, vect(data_final_sf))
data_sf <- cbind(data_final_sf, extraccion[, -1])
view (data_sf)
```


# Modelamiento ----------------------------------------------------------------

```{r}
library(caret)        # Para ajuste de modelos
library(randomForest) # Random Forest
library(ranger)
```

# ============================================================
# . Resumen de los datos espaciales
# ============================================================

```{r}
summary(data_sf)
```

# ============================================================
# . Convertir a dataframe para modelado, no se tiene en cuenta la columna ID
# ============================================================

```{r}
data_sf_df <- data.frame(data_sf)[2:12]
data_sf_df <- na.omit(data_sf_df)#
summary(data_sf_df)
```



```{r}
library(caret)

resultados_Lim_Sup_SVM <- data.frame(
  seed = integer(),
  C = numeric(),
  sigma = numeric(),
  RMSE_train = numeric(),
  R2_train = numeric(),
  RMSE_test = numeric(),
  R2_test = numeric()
)

best_rmse  <- Inf
best_model <- NULL
best_seed  <- NA


for (s in 1:500) {

  set.seed(s)

  index <- createDataPartition(
    y = data_sf_df$Lim_sup,
    p = 0.70,
    list = FALSE
  )

  train <- data_sf_df[index, ]
  test  <- data_sf_df[-index, ]

  train_control <- trainControl(
    method = "cv",
    number = 10,
    allowParallel = TRUE
  )

  GRID_SVM <- expand.grid(
    sigma = c(0.01, 0.05, 0.1),
    C = c(1, 5, 10)
  )

  best_rmse_seed   <- Inf
  best_model_seed  <- NULL
  best_C_seed      <- NA
  best_sigma_seed  <- NA

  for (i in 1:nrow(GRID_SVM)) {

    modelo <- train(
      Lim_sup ~ .,
      data = train,
      method = "svmRadial",
      trControl = train_control,
      tuneGrid = GRID_SVM[i, , drop = FALSE],
      preProcess = c("center", "scale")
    )

    pred <- predict(modelo, test)
    RMSE_test <- RMSE(pred, test$Lim_sup)

    if (RMSE_test < best_rmse_seed) {
      best_rmse_seed  <- RMSE_test
      best_model_seed <- modelo
      best_C_seed     <- GRID_SVM$C[i]
      best_sigma_seed <- GRID_SVM$sigma[i]
    }
  }

  train_metrics <- best_model_seed$results[
    best_model_seed$results$C == best_C_seed &
    best_model_seed$results$sigma == best_sigma_seed, ]

  RMSE_train <- train_metrics$RMSE
  R2_train   <- train_metrics$Rsquared

  pred <- predict(best_model_seed, test)
  RMSE_test <- RMSE(pred, test$Lim_sup)
  R2_test   <- cor(pred, test$Lim_sup)^2

  resultados_Lim_Sup_SVM <- rbind(
    resultados_Lim_Sup_SVM,
    data.frame(
      seed = s,
      C = best_C_seed,
      sigma = best_sigma_seed,
      RMSE_train = RMSE_train,
      R2_train = R2_train,
      RMSE_test = RMSE_test,
      R2_test = R2_test
    )
  )

  if (RMSE_test < best_rmse) {
    best_rmse  <- RMSE_test
    best_model <- best_model_seed
    best_seed  <- s
  }
}

best_seed
best_rmse
best_model

print(resultados_Lim_Sup_SVM)


```


```{r}
library(caret)

var_imp_svm_obj <- varImp(best_model, scale = TRUE)

print(var_imp_svm_obj)

```


```{r}
imp <- var_imp_svm_obj$importance

imp$variables <- rownames(imp)
rownames(imp) <- NULL

var_imp_svm <- imp[, c("variables", "Overall")]
colnames(var_imp_svm) <- c("variables", "importance")

var_imp_svm$importance <- as.numeric(var_imp_svm$importance)
var_imp_svm <- var_imp_svm[order(-var_imp_svm$importance), ]

print(var_imp_svm)

```


```{r}
library(ggplot2)
library(dplyr)

SVM_Sup <- ggplot(var_imp_svm %>% arrange(importance),
       aes(x = reorder(variables, importance), y = importance)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(
    x = "Variables",
    y = "Importancia",
    title = "Importancia de variables – SVM (Lim_sup)"
  ) +
  theme_minimal() +
  theme(
    axis.text  = element_text(size = 10),
    axis.title = element_text(size = 14),
    plot.title = element_text(size = 18)
  )
plot(SVM_Sup)
```


```{r}

ggsave(
  filename = "Importancia_variables_SVM.png",
  plot = SVM_Sup,
  path = "D:/MAESTRIA/Trabajo_final/graficos resultados",
  width = 18,
  height = 14,
  units = "cm",
  dpi = 300
)
```




############ \# Predicción y visualización --------------------------------

# ============================================================
# .Nombres de capas = variables del modelo
# ============================================================

```{r}

dataVARS <- c( "CI","C.O", "MCARI", "LS_Factor", "NDTI", "HV",
 "Relative_Slope_Position", "Suelos_", "Topographic_Wetness_Index" ,"Valley_Depth")


# En terra usamos 'subset' para quedarnos solo con las capas que necesitamos
# Asumiendo que tu objeto raster se llama 'raster' (o cámbiale el nombre)
r_predictores <- subset(raster, dataVARS)

# Verificación de seguridad (Debe salir T
print("¿Están todas las variables?")
print(all(dataVARS %in% names(r_predictores)))

```


```{r}
library(terra)


Limite_Sup_SVM <- terra::predict(
  r_predictores,
  model = best_model,   # ← OBLIGATORIO
  fun = function(model, d, ...) {
    predict(model, d)
  },
  na.rm = TRUE
)

plot(
  Limite_Sup_SVM,
  main = "Predicción del Límite Superior (SVM)"
)


```

# ============================================================
# .Guardar modelo rf_grid
# ============================================================
```{r}
writeRaster(Limite_Sup_SVM, "D:/Mapa final/Limite_Superior_SVM.tif", overwrite = TRUE)
```
# ============================================================
# .Guardar imagen png modelo rf_grid
# ============================================================
```{r}
png(
  "D:/MAESTRIA/Trabajo_final/graficos resultados/Limite_Superior_SVM.png",
  width = 3000,
  height = 2500,
  res = 300
)

plot(
  Limite_Sup_SVM,
  main = "Predicción del Límite Superior del departamento de Meta y Vichada (SVM)"
)

dev.off()
```

# ============================================================
# .hacer recorte de un area especifica
# ============================================================
```{r}
library(terra)

# Raster de predicción
r <- Limite_Sup_SVM   # o rast("Limite_Superior_RF.tif")

# Polígono de la zona de interés
zona <- vect("D:/MAESTRIA/Trabajo_final/shp tesis/Altillanura_2.shp")

```


# ============================================================
# .Reproyectar  
# ============================================================
```{r}
zona <- project(zona, crs(r))

```

# ============================================================
# .Cortar area de estudio  
# ============================================================

```{r}
r_crop <- crop(r, zona)
r_crop <- mask(r_crop, zona)

```

# ============================================================
# .Mapa  
# ============================================================

```{r}
plot(r_crop, main = "Predicion Limite Superior (SVM)\n Altillanura Plana del Departamento del Meta")

```
# ============================================================
# .Guardar mapa  
# ============================================================

```{r}
writeRaster(
  r_crop,
  "D:/Mapa final/Lim_sup_SVM_Altillanura.tif",
  overwrite = TRUE
)

```

# ============================================================
# .Guardar mapa como imagen  
# ============================================================

```{r}
png(
  "D:/MAESTRIA/Trabajo_final/graficos resultados/Limite_Superior_Altillanura_SVM.png",
  width = 3000,
  height = 2500,
  res = 300
)

plot(
  r_crop,
  main = "Predicion Limite Superior (SVM)\n Altillanura Plana del Departamento del Meta"
)

dev.off()

```
